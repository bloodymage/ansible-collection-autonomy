- name: "Prepare playbook environment"
  hosts: all:!public_zone
  ignore_unreachable: yes
  roles:
    - role: bloodymage.rebeldream.config_environment
      tags:
        - always
    - role: bloodymage.rebeldream.config_realm_environment

- name: "Configure baseline Kerberos"
  hosts: internal_network:!routeros
  roles:
    - role: bloodymage.rebeldream.krb5_client_config

# ==================================================================================================
#
# If we are recreating the realm, we need to:
# 1. Remove all old files from previous iteration on all domain controller hosts
# 2. Create the realm on an initial controller
# 3. Join subesquent domain controller to domain as domain controllers
#
# ==================================================================================================
- hosts: samba_domain_controllers:samba_file_servers
  roles:
    - role: bloodymage.rebeldream.samba_domain_clean_environment
      when:
        - __samba_recreate_realm
      tags:
        - samba_domain_controller
        - samba-domain-controller
        - recreate-realm

- hosts: samba_schema_master
  roles:
    - role: bloodymage.rebeldream.samba_domain_initial_controller
      when:
        - __samba_recreate_realm
      tags:
        - samba_domain_controller
        - samba-domain-controller
        - recreate-realm

- hosts: samba_domain_controllers
  roles:
    - role: bloodymage.rebeldream.samba_domain_controller
      tags:
        - samba_domain_controller
        - samba-domain-controller
        - recreate-realm

- hosts: samba_schema_master
  roles:
    - role: bloodymage.rebeldream.config_ownca_environment
    - role: bloodymage.rebeldream.samba_domain_users
      tags:
        - samba_domain_users
        - samba-domain-users
        - samba_domain_users_debug
        - samba-domain-users-debug
        - recreate-realm

- hosts: openldap_servers
  roles:
    - role: bloodymage.rebeldream.openldap
      tags:
        - never
        - openldap

- hosts: sssd
  roles:
    - role: bloodymage.rebeldream.sssd
      tags:
        - sssd
        - recreate-realm

- hosts: keytabs
  roles:
    - role: bloodymage.rebeldream.samba_domain_keytabs
      tags:
        - samba-domain-keytabs
        - recreate-realm

- hosts: keycloak_servers:!public_zone
  roles:
    - role: bloodymage.rebeldream.keycloak
      tags:
        - keycloak
        - recreate-realm

# Need to add in specific file server(s) (ones with user home directories).
- hosts: workstations:&linux
  roles:
    - role: bloodymage.rebeldream.dotfiles
      vars:
        dotfiles_users: "{{ domain_users }}"
        dotfiles_home: "/home/{{ rebeldream_org_unit_name | upper }}"
      tags:
        - dotfiles

- hosts: samba_ownca_user_hosts
  roles:
    - role: bloodymage.rebeldream.ownca_user_certs
      tags:
        - ownca_user_certs
        - ownca-user-certs
        - ownca_user_certs_debug
        - ownca-user-certs-debug
        - recreate-realm

- hosts: samba_ownca_user_hosts:workstations:&linux
  roles:
    - role: bloodymage.rebeldream.sshca_user_certs
      tags:
        - sshca-user-certs
        - recreate-realm

- hosts: samba_schema_master
  roles:
    - role: bloodymage.rebeldream.samba_domain_user_certs
      tags:
        - samba-domain-user-certs
        - recreate-realm

- hosts: freeradius_servers
  roles:
    - role: bloodymage.rebeldream.freeradius
      tags:
        - freeradius
