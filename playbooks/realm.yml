- name: "Prepare playbook environment"
  hosts: all:!public_zone
  ignore_unreachable: yes
  roles:
    - bloodymage.rebeldream.config_environment
  tasks:
    - name: "Set default domain recreation"
      ansible.builtin.set_fact:
        __samba_recreate_realm: no
      become: no

    - name: "Determine whether to force domain recreation"
      ansible.builtin.set_fact:
        __samba_recreate_realm: yes
      become: no
      tags:
        - never
        - recreate-realm

    - name: Print Samba Schema Master Role
      debug:
        msg:
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[1].split('=')[1] }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[6].split('=')[1] }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[7].split('=')[1] }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[8].split('=')[1] }}"
        verbosity: 1
      become: no
      when:
        - __samba_schema_master_role is defined
      tags:
        - never
        - debug

    - name: Print Variables
      debug:
        msg:
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[0] }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[1] }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[2] }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3] }}"
        verbosity: 2
      become: no
      when:
        - __samba_schema_master_role is defined
      tags:
        - never
        - debug

    - name: Print Variables
      debug:
        var: __samba_schema_master_role.stdout_lines[0]
        verbosity: 3
      become: no
      when:
        - __samba_schema_master_role is defined
      tags:
        - never
        - debug

    - name: Print Variables
      debug:
        var: __samba_schema_master_role.stdout_lines
        verbosity: 4
      become: no
      when:
        - __samba_schema_master_role is defined
      tags:
        - never
        - debug

    - name: Print Variables
      debug:
        var: __samba_schema_master_role
        verbosity: 4
      become: no
      when:
        - __samba_schema_master_role is defined
      tags:
        - never
        - debug

- hosts: internal_network:!routeros
  name: "Configure baseline Kerberos"
  roles:
    - role: bloodymage.rebeldream.krb5_client_config

# ==================================================================================================
#
# If we are recreating the realm, we need to:
# 1. Remove all old files from previous iteration on all domain controller hosts
# 2. Create the realm on the schema master host
# 3. Configure all subesquent domain controller hosts
#
# ==================================================================================================
# - hosts: samba_domain_controllers
#   roles:
#     - role: bloodymage.rebeldream.samba_domain_clean_environment
#       tags:
#         - samba_domain_controller
#         - samba-domain-controller

# - hosts: samba_schema_master
#   roles:
#     - role: bloodymage.rebeldream.samba_domain_controller
#       tags:
#         - samba_domain_controller
#         - samba-domain-controller

- hosts: samba_domain_controllers
  tasks:
    - name: "Set Samba Schema Master to Running Schema Master (Only if not regenerating realm)"
      command:
        cmd: "samba-tool fsmo show"
      register: __samba_schema_master_role
      run_once: yes
      become: yes
      when:
        - not __samba_recreate_realm
      tags:
        - always

    - name: Set Samba Schema Master if domain exists
      ansible.builtin.set_fact:
        __samba_schema_master: "{{ __samba_schema_master_list | join('.') }}"
      become: no
      vars:
        __samba_schema_master_list:
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[1].split('=')[1] | lower }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[6].split('=')[1] | lower }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[7].split('=')[1] | lower }}"
          - "{{ __samba_schema_master_role.stdout_lines[0].split(' ')[3].split(',')[8].split('=')[1] | lower }}"
      when:
        - __samba_schema_master_role is defined
        - __samba_schema_master_role.stdout_lines is defined
      tags:
        - always

    - name: "Create Samba Schema Master Group"
      add_host:
        name: "{{ __samba_schema_master }}"
        groups:
          - samba_schema_master
      tags:
        - always

  roles:
    - role: bloodymage.rebeldream.samba_domain_controller
      tags:
        - samba_domain_controller
        - samba-domain-controller

- hosts: samba_schema_master
  pre_tasks:
    - name: Check if we are regenerating all ownca certs
      ansible.builtin.set_fact:
        __ownca_regenerate: yes
      become: no
      changed_when: __ownca_regenerate
      tags:
        - never
        - regenerate-ownca
  roles:
    - role: bloodymage.rebeldream.samba_domain_users
      tags:
        - samba_domain_users
        - samba-domain-users
        - samba_domain_users_debug
        - samba-domain-users-debug

# - hosts: freeipa_controllers

# - hosts: openldap_servers
#   roles:
#     - role: bloodymage.rebeldream.openldap

- hosts: sssd
  roles:
    - role: bloodymage.rebeldream.sssd
      tags:
        - sssd

- hosts: keytabs
  roles:
    - role: bloodymage.rebeldream.samba_domain_keytabs
  tags:
    - samba-domain-keytabs

- hosts: keycloak_servers:!public_zone
  roles:
    - role: bloodymage.rebeldream.keycloak
      tags:
        - keycloak

# - hosts: samba_dotfiles
#   roles:
#     - role: bloodymage.rebeldream.dotfiles

- hosts: samba_ownca_user_hosts
  roles:
    - role: bloodymage.rebeldream.ownca_user_certs
      tags:
        - ownca_user_certs
        - ownca-user-certs
        - ownca_user_certs_debug
        - ownca-user-certs-debug

- hosts: samba_ownca_user_hosts:workstations:&linux
  roles:
    - role: bloodymage.rebeldream.sshca_user_certs
      tags:
        - sshca-user-certs

- hosts: samba_schema_master
  roles:
    - role: bloodymage.rebeldream.samba_domain_user_certs
      tags:
        - samba-domain-user-certs
