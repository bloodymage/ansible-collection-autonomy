---
# ======================================================================
#
# Task "Install Common Apps"
#
# Installs a set of common apps for all systems on the network
#
# ======================================================================
- name: Include OS-specific variables.
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files: "{{ __os_variables_files }}"
      paths:
        - "vars"
  become: no
  tags:
    - apache
    - apache_debug
    - apache-debug

- name: "Install packages"
  ansible.builtin.package:
    name: "{{ packages }}"
    state: present
  become: yes
  tags:
    - apache
    - apache_debug
    - apache-debug
    - install-packages

- name: http service state
  service:
    name: apache2
    state: started
    enabled: yes
  become: yes
  tags:
    - apache
    - apache_debug
    - apache-debug

- name: "Enable Apache modules"
  community.general.apache2_module:
    state: present
    name: "{{ item }}"
  loop:
    - ssl
  notify: reload apache
  become: yes
  tags:
    - apache
    - apache_debug
    - apache-debug

# ======================================================================
#
#
#
# ======================================================================
# - name: Configure SELinux to allow httpd to connect to remote database
#   seboolean:
#     name: httpd_can_network_connect_db
#     state: true
#     persistent: yes
#   when: sestatus.rc != 0

- ansible.builtin.debug:
    msg:
      - "{{ hosts }}"
    verbosity: 2
  become: no
  tags:
    - never
    - apache_debug
    - apache-debug

- name: Create file directories for each site
  ansible.builtin.file:
    path: "/srv/www/{{ item.name }}"
    owner: www-data
    group: www-data
    state: directory
    mode: "0755"
  become: yes
  loop:
    "{{ hosts }}"
  when:
    - hosts is defined
    - item.name is defined
  tags:
    - apache
    - apache_debug
    - apache-debug

# ======================================================================
#
#
#
# ======================================================================
- name: Ensure file directories have proper permissions
  ansible.builtin.file:
    path: "/srv/www"
    owner: www-data
    group: www-data
    state: directory
    recurse: yes
    mode: "0755"
  become: yes
  loop:
    "{{ hosts }}"
  when:
    - hosts is defined
    - item.enable is defined
    - item.enabled
  tags:
    - apache
    - apache_debug
    - apache-debug
    - websites

- name: Create log directories for each site
  ansible.builtin.file:
    path: "/var/log/apache2/{{ item.name }}"
    owner: root
    group: root
    state: directory
    mode: "0770"
  become: yes
  loop:
    "{{ hosts }}"
  when:
    - hosts is defined
    - item.enable is defined
    - item.enabled
  tags:
    - apache
    - apache_debug
    - apache-debug
    - websites
