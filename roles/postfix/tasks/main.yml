---
# tasks file for mail-server
- name: "Prepare Host"
  block:
    - name: Include OS-specific variables.
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files:
            - "{{ ansible_network_os | default(none) }}.yml"
            - "{{ ansible_distribution | lower }}.yml"
            - "{{ ansible_distribution.split(' ')[0] | lower }}.yml"
            - "{{ ansible_os_family | lower }}_family.yml"
            - "{{ ansible_system | lower }}.yml"
            - main.yml
          paths:
            - "vars"
      become: no
      tags:
        - postfix
        - postfix_debug
        - postfix-debug

    - name: "Install packages"
      ansible.builtin.package:
        name: "{{ packages }}"
        state: present
      become: yes
      tags:
        - postfix
        - postfix_debug
        - postfix-debug
        - install-packages

- name: "Get Users' password from password-store"
  ansible.builtin.set_fact:
    __mail_user: "{{ mail_user }}"
    __mail_user_password: "{{ lookup('community.general.passwordstore', password_store_id + ' create=true length=' + rebeldream_password_length + ' nosymbols=true') }}"
  vars:
    password_store_id: "{{ rebeldream_domain }}/domain_users/{{ mail_user }}/password"
  no_log: yes
  become: no
  delegate_to: localhost
  register: domain_user_list
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug


- name: Install config files
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/etc/{{ item }}"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop:
    - mailname
    - aliases
  tags:
    - postfix
    - postfix_debug
    - postfix-debug


- name: "Install configuration files (Perms=644)"
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/etc/postfix/{{ item }}"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop:
    - dynamicmaps.cf
    - main.cf
    - makedefs.out
    - master.cf
  notify: restart postfix
  tags:
    - postfix
    - postfix_debug
    - postfix-debug

- name: "Install ldap user and group map files"
  ansible.builtin.template:
    src: "ldap_maps.j2"
    dest: "/etc/postfix/{{ item }}.cf"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop: "{{ postfix_ldap_maps }}"
  when:
    - inventory_hostname in groups['samba_domain']
    - mail_user_password is defined
  notify: restart postfix
  tags:
    - postfix
    - postfix_debug
    - postfix-debug

- name: "Install Configuration files (postmap update required)"
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/etc/postfix/{{ item }}"
    owner: root
    group: root
    mode: 644
  become: yes
  loop:
    - canonical
    - client_access
    - helo_access
    - transport
    - virtual
    - virtual-mailbox-domains
    - virtual-mailbox-users
  notify: map {{ item }}
  tags:
    - postfix
    - postfix_debug
    - postfix-debug

# ==================================================================================================
#
# This is separate from above because sometimes we need these only apply if we are configuring
# authentication to an external relay server
#
# ==================================================================================================
- name: "Install Configuration files (postmap update required)"
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/etc/postfix/{{ item }}"
    owner: root
    group: root
    mode: 644
  become: yes
  loop:
    - sasl_passwd
    - sender_relay
  notify: map {{ item }}
  when:
    - postfix_sasl_auth_users_list is defined
  tags:
    - postfix
    - postfix_debug
    - postfix-debug

- name: Create configuration files (Perms=600)
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/etc/postfix/{{ item }}"
    owner: root
    group: root
    mode: 0600
  become: yes
  loop:
    - sasl_passwd
  notify: restart postfix
  when:
    - postfix_sasl_auth_users_list is defined
  tags:
    - postfix
    - postfix_debug
    - postfix-debug
