---
- name: "Install Drupal via Composer."
  community.general.composer:
    command: create-project
    arguments: "drupal/recommended-project /srv/www/{{ item.name }}"
    working_dir: "/srv/www/{{ item.name }}"
  become: yes
  become_user: www-data
  loop: "{{ virtual_hosts }}"
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "drupal"
    - item.enabled is defined
    - item.enabled 
  tags:
    - drupal

- name: "Configure drupal's database."
  ansible.builtin.command:
    cmd: >
      drush site:install
      --db-url=mysql://{{ item.db_user}}:{{ item.db_password }}@{{ item.db_host }}:{{ mysql_port }}/{{ item.db_name }}
       --db-su={{ mysql_administrator_user }}
       --db-su-pw={{ mysql_administrator_password }}
      --account-name : {{ item.administrator_account }}
      --account-mail : {{ item.administrator_email }}
      --account-pass : {{ item.administrator_password }}
      --site-name : {{ item.site_name }}
      --site-mail : {{ item.site_mail }}
      --site-pass : {{ item.site_password }}
    chdir: "/srv/www/{{ item.name }}"
  become: yes
  become_user: www-data
  loop: "{{ virtual_hosts }}"
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "drupal"
    - item.enabled is defined
    - item.enabled 
  tags:
    - drupal
