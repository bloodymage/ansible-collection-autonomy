---
# tasks file for samba-domain-member
- name: Determine if host is already joined as a domain member
  ansible.builtin.set_fact:
    __samba_joined_as_domain_member: yes
  become: no
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

- name: "Pre-tasks"
  block:
    - name: Include OS-specific variables.
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files: "{{ __os_variables_files }}"
          paths:
            - "vars"
      become: no
      tags:
        - samba_file_server
        - samba-file-server
        - samba_file_server_debug
        - samba-file-server-debug
        - recreate-realm
        - recreate-realm-debug

    - name: "Install packages"
      ansible.builtin.package:
        name: "{{ packages }}"
        state: present
      become: yes
      tags:
        - samba_file_server
        - samba-file-server
        - samba_file_server_debug
        - samba-file-server-debug
        - install-packages
        - recreate-realm
        - recreate-realm-debug

# Create Config File
- name: Install smb.conf configuration file
  ansible.builtin.template:
    src: "smb.conf.j2"
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: 0644
  become: yes
  notify: restart samba-domain-member
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

# Create Config File
- name: Install user.map
  ansible.builtin.template:
    src: "user.map.j2"
    dest: /etc/samba/user.map
    owner: root
    group: root
    mode: 0644
  become: yes
  notify: restart samba-domain-member
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

# ==================================================================================================
#
# Join Domain
#
# ==================================================================================================
- name: "Ensure we have a password for the Samba Administrator account"
  ansible.builtin.set_fact:
    samba_administrator_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
  become: no
  vars:
    __password_store_id: "{{ rebeldream_domain }}/domain_users/administrator/password"
    __password_length: "length={{ item.password_legnth | default(rebeldream_password_length) }}"
    __password_overwrite: "overwrite={{ rebeldream_overwrite_password }} backup=yes"
    __password_create: "create=true"
    __password_symbols: "nosymbols=true"
    __password_lookup: "{{ __password_store_id }} {{ __password_create }} {{ __password_length }} {{ __password_symbols }} {{ __password_overwrite }}"
  when:
    - samba_administrator_password == "password"
  no_log: yes

# - name: Test if host is already join to domain
#   ansible.builtin.command:
#     cmd: "net ads testjoin"

- name: Join Domain
  ansible.builtin.expect:
    command: "net ads join -U administrator"
    responses:
      (?i)password: "{{ samba_administrator_password }}"
  become: yes
  notify: start samba-domain-member
  when:
    - not __samba_joined_as_domain_member
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

- name: "Set SeDiskOperatorPrivilege for unixadmins so they can set ACLs"
  ansible.builtin.expect:
    command: "net rpc rights grant '{{ rebeldream_org_unit_name | upper }}\\unixadmins' SeDiskOperatorPrivilege -U '{{ rebeldream_org_unit_name | upper }}\\administrator'"
    responses:
      (?i)password: "{{ samba_administrator_password }}"
  become: yes
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug
