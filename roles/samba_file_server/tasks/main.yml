---
# tasks file for samba-domain-member
- name: Determine if host is already joined as a domain member
  ansible.builtin.set_fact:
    __samba_joined_as_domain_member: yes
  become: no
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

- name: "Pre-tasks"
  block:
    - name: Include OS-specific variables.
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files: "{{ __os_variables_files }}"
          paths:
            - "vars"
      become: no
      tags:
        - samba_file_server
        - samba-file-server
        - samba_file_server_debug
        - samba-file-server-debug
        - recreate-realm
        - recreate-realm-debug

    - name: "Install packages"
      ansible.builtin.package:
        name: "{{ packages }}"
        state: present
      become: yes
      tags:
        - samba_file_server
        - samba-file-server
        - samba_file_server_debug
        - samba-file-server-debug
        - install-packages
        - recreate-realm
        - recreate-realm-debug

# ==================================================================================================
#
# We need a way to check if the file server is part of a samba domain or not.  If it is, we need to
# set samba security to 'ADS' else it can be another option.
#
# ==================================================================================================
- name: "Install smb.conf configuration file."
  ansible.builtin.template:
    src: "smb.conf.j2"
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: 0644
  become: yes
  notify: restart samba-domain-member
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

# Create Config File
- name: Install user.map
  ansible.builtin.template:
    src: "user.map.j2"
    dest: /etc/samba/user.map
    owner: root
    group: root
    mode: 0644
  become: yes
  notify: restart samba-domain-member
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

# ==================================================================================================
#
# Join Domain
#
# ==================================================================================================
# - name: Test if host is already join to domain
#   ansible.builtin.command:
#     cmd: "net ads testjoin"

- name: Join Domain
  ansible.builtin.expect:
    command: "net ads join -U administrator"
    responses:
      (?i)password: "{{ __samba_administrator_password }}"
  become: yes
  notify: start samba-domain-member
  vars:
    __samba_administrator_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
    __password_store_id: "{{ autonomy_domain }}/domain_users/administrator/password"
    __password_lookup: "{{ __password_store_id }}"
  no_log: yes
  when:
    - not __samba_joined_as_domain_member
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug

- name: "Set SeDiskOperatorPrivilege for unixadmins so they can set ACLs"
  ansible.builtin.expect:
    command: >
      net rpc rights grant '{{ autonomy_org_unit_name | upper }}\unixadmins'
      SeDiskOperatorPrivilege -U '{{ autonomy_org_unit_name | upper }}\Administrator'
    responses:
      (?i)password: "{{ __samba_administrator_password }}"
  become: yes
  vars:
    __samba_administrator_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
    __password_store_id: "{{ autonomy_domain }}/domain_users/administrator/password"
    __password_lookup: "{{ __password_store_id }}"
  tags:
    - samba_file_server
    - samba-file-server
    - samba_file_server_debug
    - samba-file-server-debug
    - recreate-realm
    - recreate-realm-debug
