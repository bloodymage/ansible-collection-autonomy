---
# tasks file for sssd
# ==================================================================================================
#
# Task: Install apps
#
# ==================================================================================================
- name: Include OS-specific variables.
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files: "{{ __os_variables_files }}"
      paths:
        - "vars"
  become: no
  tags:
    - sssd
    - sssd_debug
    - sssd-debug
    - install-packages

- name: "Install packages"
  ansible.builtin.package:
    name: "{{ packages }}"
    state: present
  become: yes
  tags:
    - sssd
    - sssd_debug
    - sssd-debug
    - install-packages
  notify: restart sssd

- name: stop sssd
  service:
    name: sssd
    state: stopped
  become: yes
  tags:
    - never
    - samba-domain-create

- name: Leave Realm
  ansible.builtin.command: "realm leave"
  tags:
    - never
    - samba-domain-create

- name: Clear old data
  ansible.builtin.file:
    path: /var/lib/sss/db
    state: absent
  tags:
    - never
    - samba-domain-create

- name: Ensure DB directory exists
  ansible.builtin.file:
    path: /var/lib/sss/db
    state: direcotory
    owner: sssd
    group: sssd
    mode: "0755"
  tags:
    - never
    - samba-domain-create

- name: Join Realm
  ansible.builtin.command: "realm join {{ rebeldream_domain }}"
  become: yes
  tags:
    - never
    - samba-domain-create

- name: "Install sssd.conf"
  ansible.builtin.template:
    src: "{{ role_path }}/templates/sssd.conf.j2"
    dest: "/etc/sssd/sssd.conf"
    owner: root
    group: root
    mode: "0600"
  become: yes
  notify: restart sssd
  tags:
    - sssd
    - sssd_debug
    - sssd-debug

- name: "Ensure pam_preauth_available file exists"
  ansible.builtin.file:
    path: "/var/lib/sss/pubconf/pam_preauth_available"
    owner: "root"
    group: "root"
    mode: "0600"
    state: touch
  become: yes
  notify: restart sssd
  tags:
    - sssd
    - sssd_debug
    - sssd-debug
