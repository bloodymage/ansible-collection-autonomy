---
# ==================================================================================================
#
# OS Specific Setup
#
#
# ==================================================================================================
- name: "Pre-tasks"
  block:
    - name: "Include OS-specific variables."
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files: "{{ __os_variables_files }}"
          paths:
            - "vars"
      become: no
      when:
        - autonomy_virtual_host is falsy
        - inventory_hostname not in groups['public_zone'] | default([])

    - name: "Install packages."
      ansible.builtin.package:
        name: "{{ autonomy_packages }}"
        state: present
      become: yes
      when:
        - autonomy_virtual_host is falsy
        - inventory_hostname not in groups['public_zone'] | default([])

# ==================================================================================================
#
# Set Variables
#
# ==================================================================================================
# - name: "Check bind version."
#   ansible.builtin.debug:
#     msg:
#       - "{{ ansible_facts.packages['bind9'][0]['version'] }}"
#   when: "'bind9' in ansible_facts.packages"

# ==================================================================================================
#
# Really need a way to defined failed instead of ignore_errors.
#
# If the zone is brand new, there won't be a name server to query.  Querying the server will fail.
# We still want this role to continue so it can create a brand new zone.  ignore_errors works, but
# it feels ugly.
#
# Are these tasks even needed anymore because of the change to update zones dynamically?
#
# ==================================================================================================
# - name: "Query DNS for zone SOA."
#   ansible.builtin.set_fact:
#     __zone_soa: "{{ lookup('community.general.dig', autonomy_domain + '/SOA') }}"
#     __zone_all: "{{ lookup('community.general.dig', autonomy_domain, 'qtype=NS', wantlist=True) }}"
#   become: no
#   ignore_errors: true

# - name: "Query DNS for reverse zone SOA."
#   ansible.builtin.set_fact:
#     __reverse_zone_soa: "{{ lookup('community.general.dig', bind_reverse_zone + '/SOA') }}"
#     __reverse_zone_all: "{{ lookup('community.general.dig', bind_reverse_zone, 'qtype=NS', wantlist=True) }}"
#   become: no
#   ignore_errors: true
#   when:
#     - bind_reverse_zone is defined

# - name: "Get Forward Zone's Current Serial Number."
#   ansible.builtin.set_fact:
#     __zone_current_serial_number: "{{ __zone_soa.split(' ')[2] | default(bind_zone_serial_number)}}"
#   become: no

# - name: "Get Reverse Zone's Current Serial Number."
#   ansible.builtin.set_fact:
#     __reverse_zone_current_serial_number: "{{ __reverse_zone_soa.split(' ')[2] | default(bind_reverse_zone_serial_number) }}"
#   become: no
#   when:
#     - bind_reverse_zone is defined

# - name: "Set new Forward Zone Serial Number."
#   ansible.builtin.set_fact:
#     bind_zone_serial_number: "{{ __zone_current_serial_number | int + 1 }}"
#   become: no
#   when:
#     - __zone_current_serial_number is defined
#     - __zone_current_serial_number >= bind_zone_serial_number

# - name: "Set new Reverse Zone Serial Number."
#   ansible.builtin.set_fact:
#     bind_reverse_zone_serial_number: "{{ __reverse_zone_current_serial_number | int + 1 }}"
#   become: no
#   when:
#     - __reverse_zone_current_serial_number is defined
#     - __reverse_zone_current_serial_number >= bind_reverse_zone_serial_number

# - name: "Check new serial number."
#   ansible.builtin.debug:
#     msg:
#       - "Current Serial Number: {{ __zone_current_serial_number }}"
#       - "New Serial Number:     {{ bind_zone_serial_number }}"
#     verbosity: 1
#   become: no
#   when:
#     - __zone_current_serial_number is defined

# ==================================================================================================
#
# The included tasks generate keys used for dynamic dns
#
# ==================================================================================================
- name: "Configure Dynamic DNS Keys."
  include_tasks: dynamic_dns.yml

# ==================================================================================================
#
# Install Configuration files
#
# ==================================================================================================
- name: "Install Bind Config Files."
  ansible.builtin.template:
    src: "etc/bind/{{ item }}.j2"
    dest: "{{ bind_conf_dir }}/{{ item }}"
    owner: root
    group: root
    mode: "0644"
    #validate: "{{ __bind_named_checkconf }} %s"
  become: yes
  loop: "{{ bind_config_files }}"
  when:
    - bind_dyndns_secret is defined
    - inventory_hostname not in groups['public_zone'] | default([])
    - autonomy_virtual_host is falsy
    - (autonomy_bind_forwardzones is defined or inventory_hostname in groups['samba_domain_controllers'])
    - groups['dmz_dns_servers'] is defined # Temporary fix for #534
  notify: restart bind

# ==================================================================================================
#
# This creates the following directories:
#   - /var/lib/bind/
#   - /var/cache/bind/
#
# These are set 0775 so that the bind group can make changes.
#
# ==================================================================================================
- name: "Ensure Zone Directories Exists and are writable by bind user."
  ansible.builtin.file:
    dest: "{{ item.name }}"
    state: directory
    owner: "{{ bind_owner }}"
    group: "{{ bind_group }}"
    mode: "{{ item.mode }}"
  become: yes
  loop: "{{ __autonomy_bind_zone_directories }}"
  when:
    - autonomy_virtual_host is falsy
    - bind_dyndns_secret is defined
    - inventory_hostname not in groups['public_zone'] | default([])

# ==================================================================================================
#
# Flush the handlers (restart bind9) to ensure bind is running with the current configuration. This
# fixes a problem where the root dns zone file can not be downloaded because bind is not running,
# which causes dns lookup errors on the next step.
#
# It also will cause the play to end for any host that has an invalid configuration right away.
#
# ==================================================================================================
- name: "Ensure bind is up and running."
  ansible.builtin.meta: flush_handlers

# ==================================================================================================
#
# Install Zone Files
#
# FIXME: This fails if bind daemon is not running.
#
# Set 'force' to 'no' because once installed bind will update the file itself.  Only needed if the
# file does not exist.
#
# ==================================================================================================
- name: "Download Root Zone file."
  ansible.builtin.get_url:
    url: "http://www.internic.net/domain/root.zone"
    dest: "{{ bind_cache_dir }}/db.root"
    owner: bind
    group: bind
    mode: "0644"
    force: no
  become: yes
  when:
    - autonomy_virtual_host is falsy
    - bind_dyndns_secret is defined
    - inventory_hostname not in groups['public_zone'] | default([])

# ==================================================================================================
#
# The next two templates have 'force' set to 'no' so that they only install a new zone file if one
# does not already exist.  Any further updates are done via the 'nsupdate' module in either the
# dns_forwardzone or dns_reversezone roles.
#
# ==================================================================================================
- name: "Installing Forward Zone files."
  ansible.builtin.template:
    src: "var/lib/bind/forwardzone.j2"
    dest: "{{ bind_zone_dir }}/db.{{ autonomy_domain }}"
    owner: "{{ bind_owner }}"
    group: "{{ bind_group }}"
    mode: "0644"
    force: no
    #validate: "{{ __bind_named_checkzone }} {{ item['domain'] }} %s"
  become: yes
  register: forwardzone_refresh
  when:
    - not autonomy_bind_zone_samba_controlled
    - inventory_hostname not in groups['samba_domain_controllers'] | default([])
  notify: restart bind

- name: "Installing Reverse Zone files."
  ansible.builtin.template:
    src: "var/lib/bind/reversezone.j2"
    dest: "{{ bind_zone_dir }}/db.{{ item['name'] }}"
    owner: "{{ bind_owner }}"
    group: "{{ bind_group }}"
    mode: "0644"
    force: no
    #validate: "{{ __bind_named_checkzone }} {{ item.name }} %s"
  loop: "{{ autonomy_bind_reversezones }}"
  become: yes
  register: reversezone_refresh
  when:
    - autonomy_bind_reversezones is defined
    - inventory_hostname not in groups['samba_domain_controllers'] | default([])
  notify: restart bind
