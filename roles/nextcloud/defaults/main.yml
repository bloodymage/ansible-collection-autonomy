---
# defaults file for nextcloud
__packages_base:
  - apache2
  - php-gd
  - php-mysql
  - php-curl
  - php-mbstring
  - php-intl
  - php-gmp
  - php-bcmath
  - php-imagick
  - php-xml
  - php-zip

__packages_ldap:
  - php-ldap

__packages_gnupg:
  - php-gnupg

__packages_redis:
  - php-redis

packages: "{{ __packages_base + __packages_ldap + __packages_gnupg + __packages_redis }}"

# Required:
# PHP (7.2, 7.3 or 7.4)
# PHP module ctype
# PHP module dom
# PHP module hash (only on FreeBSD)
# PHP module iconv
# PHP module JSON
# PHP module libxml (Linux package libxml2 must be >=2.7.0)
# PHP module openssl
# PHP module posix
# PHP module session
# PHP module SimpleXML
# PHP module XMLReader
# PHP module XMLWriter
# PHP module zlib

# Recommended packages:
# PHP module fileinfo (highly recommended, enhances file analysis performance)
# PHP module bz2 (recommended, required for extraction of apps)

# Required for specific apps:
# PHP module smbclient (SMB/CIFS integration, see SMB/CIFS)
# PHP module ftp (for FTP storage / external user authentication)
# PHP module imap (for external user authentication)

# Recommended for specific apps (optional):
# PHP module exif (for image rotation in pictures app)

# For enhanced server performance (optional) select one of the following memcaches:
# PHP module apcu (>= 4.0.6)
# PHP module memcached

# For preview generation (optional):
# avconv or ffmpeg
# OpenOffice or LibreOffice

# For command line processing (optional):
# PHP module pcntl (enables command interruption by pressing ctrl-c)

nextcloud_public_gpg_key: "https://nextcloud.com/nextcloud.asc"
nextcloud_version: "20.0.3"
nextcloud_source_url:
  - source: "https://download.nextcloud.com/server/releases/nextcloud-{{ nextcloud_version }}.tar.bz2"
    file: "nextcloud-{{ nextcloud_version }}.tar.bz2"
    signature: "https://download.nextcloud.com/server/releases/nextcloud-{{ nextcloud_version }}.tar.bz2.asc"
    checksum: "https://download.nextcloud.com/server/releases/nextcloud-{{ nextcloud_version }}.tar.bz2.sha256"

nextcloud_admin_user: "administrator"
nextcloud_admin_password: "password"
nextcloud_ldap_password: "password"
nextcloud_password_legnth: "{{ rebeldream_password_length }}"

nextcloud_post_max_size: "512M"
nextcloud_upload_max_filesize: "512M"
nextcloud_memory_limit: "512M"
nextcloud_hsts_max_age: 15552000

nextcloud_data_directory: "/srv/www-data/nextcloud/"

nextcloud_apps:
  - accessibility
  - activity
  - admin_audit
  - cloud_federation_api
  - comments
  - contactsinteraction
  - dashboard
  - dav
  - federatedfilesharing
  - federation
  - files
  - files_external
  - files_rightclick
  - files_sharing
  - files_trashbin
  - files_versions
  - firstrunwizard
  - logreader
  - lookup_server_connector
  - notifications
  - oauth2
  - password_policy
  - photos
  - privacy
  - provisioning_api
  - recommendations
  - serverinfo
  - settings
  - sharebymail
  - support
  - systemtags
  - text
  - theming
  - twofactor_backupcodes
  - updatenotification
  - user_status
  - viewer
  - weather_status
  - workflowengine

nextcloud_password_length: "{{ rebeldream_password_length }}"

nextcloud_group_members: "({{ samba_member_of }}=cn=nextcloudusers,{{ rebeldream_user_dn }})"
nextcloud_samba_user_filter: "(&{{ samba_user_class }}{{ samba_search }}{{ samba_enabled_users }}{{ nextcloud_group_members }})"
nextcloud_samba_login_filter: "(&{{ samba_user_class }}{{ samba_enabled_users }}({{ nextcloud_group_members }})"
nextcloud_samba_group_filter: "(&{{ samba_group_class }}{{ nextcloud_group_members }}"

nextcloud_ldap_config_ids:
  - type: ldap
    id: s01
    ldap_config:
      - ldap_attribute: "ldapBase"
        ldap_value: "cn=users,{{ rebeldream_base_dn }}"
      - ldap_attribute: "ldapBaseUsers"
        ldap_value: "{{ rebeldream_user_dn }}"
      - ldap_attribute: "ldapBaseGgroups"
        ldap_value: "{{ rebeldream_group_dn }}"
      - ldap_attribute: "ldapUserDisplayName"
        ldap_value: "displayname"
      - ldap_attribute: "ldapAgentName"
        ldap_value: "cn=nextcloud,{{ rebeldream_user_dn }}"
      - ldap_attribute: "ldapAgentPassword"
        ldap_value: "{{ nextcloud_ldap_password }}"
      - ldap_attribute: "ldapEmailAttribute"
        ldap_value: "mail"
      - ldap_attribute: "ldapExpertUsernameAttr"
        ldap_value: "userPrincipalName"
      - ldap_attribute: "ldapGidNumber"
        ldap_value: "gidNumber"
      - ldap_attribute: "ldapGroupDisplayName"
        ldap_value: "cn"
      - ldap_attribute: "ldapGroupFilter"
        ldap_value: "{{ nextcloud_samba_group_filter }}"
      - ldap_attribute: "ldapGroupFilterMode"
        ldap_value: "0"
      - ldap_attribute: "ldapGroupMemberAssocAttr"
        ldap_value: "member"
      - ldap_attribute: "ldapHost"
        ldap_value: "192.168.0.2"
      - ldap_attribute: "ldapLoginFilter"
        ldap_value: "{{ nextcloud_samba_login_filter }}"
      - ldap_attribute: "ldapUserFilter"
        ldap_value: "{{ nextcloud_samba_user_filter }}"
      - ldap_attribute: "useMemberOfToDetectMembership"
        ldap_value: "1"

nextcloud_saml_config:
  - saml_attribute: "2-sp-name-id-format"
    saml_value: "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified"
  - saml_attribute: "enabled"
    saml_value: "yes"
  - saml_attribute: "general-allow_multiple_user_back_ends"
    saml_value: "1"
  - saml_attribute: "general-idp0_display_name"
    saml_value: "Keycloak"
  - saml_attribute: "general-require_provisioned_account"
    saml_value: "1"
  - saml_attribute: "general-uid_mapping"
    saml_value: "userPrincipalName"
            # "general-use_saml_auth_for_desktop": "1"
            # "idp-entityId": "https:\/\/warspite.swg.drbr.org\/auth\/realms\/olympus"
            # "idp-singleLogoutService.url": "https:\/\/warspite.swg.drbr.org\/auth\/realms\/olympus\/protocol\/saml"
            # "idp-singleSignOnService.url": "https:\/\/warspite.swg.drbr.org\/auth\/realms\/olympus\/protocol\/saml"
            # "idp-x509cert": ""
            # "installed_version": "3.3.1"
            # "providerIds": "1"
            # "security-authnRequestsSigned": "1"
            # "security-logoutRequestSigned": "1"
            # "security-logoutResponseSigned": "1"
            # "security-lowercaseUrlencoding": "1"
            # "security-nameIdEncrypted": "0"
            # "security-signMetadata": "0"
            # "security-wantAssertionsEncrypted": "0"
            # "security-wantAssertionsSigned": "1"
            # "security-wantMessagesSigned": "1"
            # "security-wantNameId": "0"
            # "security-wantXMLValidation": "0"
            # "sp-name-id-format": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified"
            # "sp-privateKey": ""
            # "sp-x509cert": ""
            # "type": "saml"
            # "types": "authentication"


# ==================================================================================================
#
# These variables are not to be edited
#
# ==================================================================================================
nextcloud_default_apps:
  - accessibility
  - activity
  - admin_audit
  - cloud_federation_api
  - comments
  - contactsinteraction
  - dashboard
  - dav
  - encryption
  - federatedfilesharing
  - federation
  - files
  - files_external
  - files_pdfviewer
  - files_rightclick
  - files_sharing
  - files_trashbin
  - files_versions
  - files_videoplayer
  - firstrunwizard
  - logreader
  - lookup_server_connector
  - nextcloud_announcements
  - notifications
  - oauth2
  - password_policy
  - photos
  - privacy
  - provisioning_api
  - recommendations
  - serverinfo
  - settings
  - sharebymail
  - support
  - survey_client
  - systemtags
  - text
  - theming
  - twofactor_backupcodes
  - updatenotification
  - user_ldap
  - user_status
  - viewer
  - weather_status
  - workflowengine
