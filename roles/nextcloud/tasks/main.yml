---
# tasks file for nextcloud
# ==================================================================================================
#
# TODO: Update this to fully qualified collection name
#
# As of ansible 2.10.3 this fails with the fully qualified collection name:
# - ansible.builtin.include_vars
#
# ==================================================================================================
- name: Include OS-specific variables.
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files: "{{ __os_variables_files }}"
      paths:
        - "vars"
  become: no
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - install-packages

- name: "Install packages"
  ansible.builtin.package:
    name: "{{ packages }}"
    state: present
  become: yes
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "nextcloud"
    - item.enabled is defined
    - item.enabled
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites
    - install-packages

# ==================================================================================================
#
#
#
# ==================================================================================================
- name: Install Apache site.conf
  ansible.builtin.template:
    src: "apache-site.conf.j2"
    dest: "/etc/apache2/sites-available/{{ item.name }}.conf"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ virtual_hosts }}"
  become: yes
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "nextcloud"
    - item.enabled is defined
    - item.enabled
  notify: reload apache
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: Check If this is a new install
  ansible.builtin.stat:
    path: "/srv/www/{{ item.name }}/config/config.php"
  loop: "{{ virtual_hosts }}"
  register: install_status
  become: no
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "nextcloud"
    - item.enabled is defined
    - item.enabled
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: "Ensure we have a password for the nextcloud admin user"
  ansible.builtin.set_fact:
    nextcloud_admin_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
  vars:
    __password_store_id: "{{ autonomy_domain }}/hosts/{{ inventory_hostname_short }}/nextcloud_admin_password"
    __password_length: "length={{ nextcloud_password_legnth }}"
    __password_overwrite: "overwrite={{ autonomy_overwrite_password }} backup=yes"
    __password_create: "create=true"
    __password_symbols: "nosymbols=true"
    __password_lookup: "{{ __password_store_id }} {{ __password_create }} {{ __password_length }} {{ __password_symbols }} {{ __password_overwrite }}"
  delegate_to: localhost
  when:
    - virtual_hosts is defined
    - nextcloud_admin_password == "password"
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: "Complete fresh install"
  include: nextcloud_install.yml
  loop: "{{ virtual_hosts }}"
  loop_control:
    loop_var: host
  when:
    - virtual_hosts is defined
    - host.content is defined
    - host.content == "nextcloud"
    - item.installed is defined
    - install_status.results.item.exists is defined
    - install_status.results.item.exists is false
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: Update php.ini
  ansible.builtin.template:
    src: "php.ini.j2"
    dest: "/etc/php/7.3/apache2/php.ini"
    owner: root
    group: root
    mode: "0644"
  become: yes
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "nextcloud"
    - item.enabled is defined
    - item.enabled
  notify: restart apache
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

# ==================================================================================================
#
# TODO: Update this to fully qualified collection name
#
# As of ansible 2.10.3 this fails with the fully qualified collection name:
# - ansible.builtin.command
#
# ==================================================================================================

- name: "Ensure we have a password for the nextcloud ldap lookup user"
  ansible.builtin.set_fact:
    nextcloud_ldap_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
  vars:
    __password_store_id: "{{ nextcloud_domain }}/domain_users/nextcloud/password"
    __password_length: "length={{ nextcloud_password_length }}"
    __password_overwrite: "overwrite={{ autonomy_overwrite_password }} backup=yes"
    __password_create: "create=true"
    __password_symbols: "nosymbols=true"
    __password_lookup: "{{ __password_store_id }} {{ __password_create }} {{ __password_length }} {{ __password_symbols }} {{ __password_overwrite }}"
  delegate_to: localhost
  when:
    - virtual_hosts is defined
    - nextcloud_ldap_password == "password"
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: Update nextcloud config
  ansible.builtin.template:
    src: "config.php.j2"
    dest: "/srv/www/{{ item.name }}/config/config.php"
    owner: www-data
    group: www-data
    mode: "0644"
  become: yes
  loop: "{{ virtual_hosts }}"
  when:
    - virtual_hosts is defined
    - item.content is defined
    - item.content == "nextcloud"
    - item.enabled is defined
    - item.enabled
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: "Install Nextcloud apps"
  include: nextcloud_apps.yml
  loop: "{{ virtual_hosts }}"
  loop_control:
    loop_var: host
  when:
    - virtual_hosts is defined
    - host.content is defined
    - host.content == "nextcloud"
  tags:
    - nextcloud
    - nextcloud_debug
    - nextcloud-debug
    - websites

- name: "Ensure we have a clean nextcloud state before we do anything else"
  ansible.builtin.command:
    cmd: >
      php occ upgrade
    chdir: "/srv/www/{{ item.name }}"
  become: yes
  become_user: www-data
  loop: "{{ virtual_hosts }}"
  when:
    - virtual_hosts is defined
    - item.content == "nextcloud"
  tags:
    - nextcloud_debug
    - nextcloud-debug
    - nextcloud
    - websites

# ==================================================================================================
#
# Need to limit this to only when 'user_ldap' app is included in 'nextcloud_apps' list
#
# Disabled for now.
#
# ==================================================================================================
# - name: "Configure LDAP"
#   include: nextcloud_ldap.yml
#   loop: "{{ virtual_hosts }}"
#   loop_control:
#     loop_var: host
#   when:
#     - virtual_hosts is defined
#     - host.content is defined
#     - host.content == "nextcloud"
#   tags:
#     - nextcloud
#     - nextcloud_debug
#     - nextcloud-debug
#     - websites
