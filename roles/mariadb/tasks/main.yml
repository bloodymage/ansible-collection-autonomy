---
# tasks file for mariadb
---
# ==================================================================================================
#
# Task "Install MariaDB Apps"
#
# Installs a set of common apps for all systems on the network
#
# ==================================================================================================
- name: Check if MySQL is already installed.
  stat: path=/etc/init.d/mysql
  register: mysql_installed

- name: "{{ ansible_os_family }}: Install MariaDB Apps"
  apt:
    name: "{{ packages }}"
    state: present
  become: yes
  tags:
    - install-packages

# Because Ubuntu starts MySQL as part of the install process, we need to stop
# mysql and remove the logfiles in case the user set a custom log file size.
- name: Ensure MySQL is stopped after initial install.
  service:
    name: "{{ mysql_daemon }}"
    state: stopped
  when: not mysql_installed.stat.exists

- name: Delete innodb log files created by apt package after initial install.
  file:
    path: "{{ mysql_datadir }}/{{ item }}"
    state: absent
  with_items:
    - ib_logfile0
    - ib_logfile1
  when: not mysql_installed.stat.exists

# - name: Ensure MySQL Root user password is set
#   mysql_user:
#     name: root
#     password: "{{ mysql_root_user_password }}"
#     state: present

- name: Removes all anonymous user accounts
  mysql_user:
    name: ''
    host_all: yes
    state: absent

- name: Add Debian Upgrade User
  mysql_user:
    name: debian-sys-maint
    password: "{{ mysql_debian_sys_maint_user_password }}"
    state: present
