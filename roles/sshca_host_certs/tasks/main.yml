---
# ==================================================================================================
#
# Tasks:
#  
#
# ==================================================================================================
- name: "Pre-tasks"
  block:
    - name: Include OS-specific variables.
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files:
            - "{{ ansible_network_os | default(none) }}.yml"
            - "{{ ansible_distribution | lower }}.yml"
            - "{{ ansible_distribution.split(' ')[0] | lower }}.yml"
            - "{{ ansible_os_family | lower }}_family.yml"
            - "{{ ansible_system | lower }}.yml"
            - main.yml
          paths:
            - "vars"
      become: no
      tags:
        - sshca_host_certs
        - sshca-host-certs
        - sshca_host_certs_debug
        - sshca-host-certs-debug
        - install-packages

    - name: "Install packages"
      package:
        name: "{{ packages }}"
        state: present
      become: yes
      tags:
        - sshca_host_certs
        - sshca-host-certs
        - sshca_host_certs_debug
        - sshca-host-certs-debug
        - install-packages

# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: Find SSH host keys.
  find:
    path: "{{ ssh_config_dir }}"
    pattern: ssh_host_*_key
  register: private_keys
  failed_when: "\"matched\" not in private_keys or private_keys.matched == 0"
  become: yes
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

- name: Create local temporary directory.
  tempfile:
    suffix: ansible-ssh-host-signer
    state: directory
  changed_when: false
  register: temporary_directory
  delegate_to: localhost
  run_once: true
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: Fetch public keys.
  fetch:
    src: "{{ item.path }}.pub"
    dest: "{{ temporary_directory.path }}/public_keys/"
  with_items: "{{ private_keys.files }}"
  changed_when: false
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: Fetch existing certificates.
  fetch:
    src: "{{ item.path }}-cert.pub"
    dest: "{{ temporary_directory.path }}/existing_certificates/"
    fail_on_missing: false
  with_items: "{{ private_keys.files }}"
  changed_when: false
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Sign SSH Keys
#
# TODO: Add serial number
# TODO: Add expiration
# TODO: Use expect module for password from ansible vault
#       https://docs.ansible.com/ansible/latest/modules/expect_module.html
#
# ======================================================================
- name: Sign SSH keys.
  expect:
    command: ssh-keygen -s "{{ ssh_ca_host_signer_key }}"
             -I "{{ ssh_ca_host_signer_id }}"
             -h -n "{{ ssh_ca_host_signer_hostnames }}"
             "{{ temporary_directory.path }}/public_keys/{{ inventory_hostname | quote }}{{ item.path | quote }}.pub"
    responses:
      (?i)passphrase: "{{ ssh_ca_host_key_password }}"
      # you don't want to show passwords in your logs
  #no_log: true
  with_items: "{{ private_keys.files }}"
  changed_when: false
  delegate_to: localhost
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: Find certificates.
  find:
    path: "{{ temporary_directory.path }}/public_keys/{{ inventory_hostname | quote}}{{ ssh_config_dir }}/"
    pattern: ssh_host_*_key-cert.pub
  register: certificates
  delegate_to: localhost
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Tasks:
# 
#
# ======================================================================
- name: Compare certificates.
  shell: diff <(ssh-keygen -L -f "{{ item.path | quote }}" |
           tail -n +2) <(ssh-keygen -L -f "{{ temporary_directory.path | quote }}/existing_certificates/{{ inventory_hostname | quote }}/{{ ssh_config_dir }}/{{ item.path | basename | quote }}" | tail -n +2)
  args:
    executable: /bin/bash
  with_items: "{{ certificates.files }}"
  changed_when: false
  failed_when: false
  register: certificate_comparison
  delegate_to: localhost
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: Copy certificates back to server.
  copy:
    src: "{{ item.item.path }}"
    dest: "{{ ssh_config_dir }}/"
  with_items: "{{ certificate_comparison.results }}"
  notify: restart ssh
  become: yes
  when:
    - item.rc != 0
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug

# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: Remove local temporary directory.
  file:
    name: "{{ temporary_directory.path }}"
    state: absent
  become: yes
  changed_when: false
  delegate_to: localhost
  run_once: true
  tags:
    - sshca_host_certs
    - sshca-host-certs
    - sshca_host_certs_debug
    - sshca-host-certs-debug
