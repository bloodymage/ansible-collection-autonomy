---
- name: "Pre-tasks"
  block:
    - name: "Set Variables"
      set_fact:
        __network_os: "{{ ansible_network_os | default(none) }}"
        __lsb_id: "{{ ansible_lsb.id | default(none) }}"
        __distribution: "{{ ansible_distribution | default(none) }}"
        __os_family: "{{ ansible_os_family | default(none) }}"
        __system: "{{ ansible_system | default(none) }}"
      become: no
      tags:
        - ownca_host_certs
        - ownca-host-certs
        - ownca_host_certificates
        - ownca-host-certificates
        - ownca_host_certs_debug
        - ownca-host-certs-debug
        - ownca_host_certificates_debug
        - ownca-host-certificates-debug

    - name: Set Variables
      set_fact:
        __distribution_short: "{{ __distribution.split(' ')[0] }}"
      become: no
      tags:
        - ownca_host_certs
        - ownca-host-certs
        - ownca_host_certificates
        - ownca-host-certificates
        - ownca_host_certs_debug
        - ownca-host-certs-debug
        - ownca_host_certificates_debug
        - ownca-host-certificates-debug

    - name: Include OS-specific variables.
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files:
            - "{{ __network_os }}.yml"
            - "{{ __lsb_id | lower }}.yml"
            - "{{ __distribution | lower }}.yml"
            - "{{ __distribution_short | lower }}.yml"
            - "{{ __os_family | lower }}_family.yml"
            - "{{ __system | lower }}.yml"
            - main.yml
          paths:
            - "vars"
      become: no
      tags:
        - ownca_host_certs
        - ownca-host-certs
        - ownca_host_certificates
        - ownca-host-certificates
        - ownca_host_certs_debug
        - ownca-host-certs-debug
        - ownca_host_certificates_debug
        - ownca-host-certificates-debug

- name: Include Family Tasks
  include: "{{ ansible_os_family | lower }}_prep.yml"
  when:
    - ansible_network_os is not defined
    - ansible_os_family is defined
    - not ownca_generate_locally
  become: no
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certificates
    - ownca-host-certificates
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca_host_certificates_debug
    - ownca-host-certificates-debug

- name: "Include tasks for localhost generation"
  include: "localhost_prep.yml"
  when:
    - ansible_network_os is defined or ownca_generate_locally
  become: no
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certificates
    - ownca-host-certificates
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca_host_certificates_debug
    - ownca-host-certificates-debug

- name: "Ensure we have a password for the Component Issuing CA"
  ansible.builtin.set_fact:
    ownca_component_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
  vars:
    __password_store_id: "{{ rebeldream_domain }}/ownca/ownca_component_password"
    __password_length: "length={{ item.password_legnth | default(rebeldream_password_length) }}"
    __password_overwrite: "overwrite={{ rebeldream_overwrite_password }} backup=yes"
    __password_create: "create=true"
    __password_symbols: "nosymbols=true"
    __password_lookup: "{{ __password_store_id }} {{ __password_create }} {{ __password_length }} {{ __password_symbols }} {{ __password_overwrite }}"
  delegate_to: localhost
  when:
    - ownca_component_password == "password"
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certs_debug
    - ownca-host-certs-debug

- name: "Generate Host Certificate"
  community.crypto.x509_certificate:
    path: "{{ ownca_hosts_directory }}/certs/{{ inventory_hostname }}.crt"
    csr_path: "{{ ownca_hosts_directory }}/csr/{{ inventory_hostname }}.csr"
    ownca_path: "{{ ownca_ca_directory }}/certs/{{ rebeldream_org_name }}-{{ rebeldream_org_unit_name }}-component-ca.crt"
    ownca_privatekey_path: "{{ ownca_ca_directory }}/private/{{ rebeldream_org_name }}-{{ rebeldream_org_unit_name }}-component-ca.key"
    ownca_privatekey_passphrase: "{{ ownca_component_password }}"
    provider: ownca
    backup: yes
    force: "{{ __ownca_regenerate }}"
  become: no
  delegate_to: localhost
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca-all

- name: Create Complete Chain Bundles
  community.crypto.certificate_complete_chain:
    input_chain: "{{ lookup('file', ownca_hosts_directory + '/certs/' + inventory_hostname + '.crt') }}"
    intermediate_certificates:
      - "{{ ownca_ca_directory }}/certs/{{ rebeldream_org_name }}-{{ rebeldream_org_unit_name }}-component-ca.crt"
      - "{{ ownca_ca_directory }}/certs/{{ rebeldream_org_name }}-{{ rebeldream_org_unit_name }}-ca.crt"
    root_certificates:
      - "{{ ownca_ca_directory }}/certs/{{ rebeldream_org_name }}-root-ca.crt"
  register: parent_cert_authorities
  become: no
  delegate_to: localhost
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca-bundles
    - ownca-all

- name: Cert Chain (Name, Ownca, Chain, Complete Chain)
  debug:
    msg:
      - "{{ parent_cert_authorities.chain }}"
      - "{{ parent_cert_authorities.complete_chain }}"
      - "{{ parent_cert_authorities.root }}"
    verbosity: 1
  delegate_to: localhost
  when:
    - parent_cert_authorities.chain is defined
  tags:
    - never
    - ownca_host_certs_debug
    - ownca-host-certs-debug

- name: Print Cert Authorities (Full)
  debug:
    msg:
      - "{{ parent_cert_authorities }}"
    verbosity: 4
  when:
    - parent_cert_authorities is defined
  delegate_to: localhost
  tags:
    - never
    - ownca_host_certs_debug
    - ownca-host-certs-debug

- name: Write complete chain to disk
  copy:
    dest: "{{ ownca_hosts_directory }}/certs/{{ inventory_hostname }}-chain.crt"
    content: "{{ ''.join(parent_cert_authorities.complete_chain) }}"
    owner: root
    group: root
    mode: "0600"
    become: no
  when:
    - parent_cert_authorities.complete_chain is defined
  delegate_to: localhost
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca-bundles
    - ownca-all

- name: Include Family Tasks
  include: "{{ ansible_os_family | lower }}_final.yml"
  when:
    - ansible_network_os is not defined
    - ansible_os_family is defined
    - not ownca_generate_locally
  become: no
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certificates
    - ownca-host-certificates
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca_host_certificates_debug
    - ownca-host-certificates-debug

- name: Include NetworkOS Tasks
  include: "{{ ansible_network_os.split('.')[2] | lower }}_final.yml"
  when:
    - ansible_network_os is defined
    - not ownca_generate_locally
  become: no
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certificates
    - ownca-host-certificates
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca_host_certificates_debug
    - ownca-host-certificates-debug

- name: Include Local tasks
  include: "localhost_final.yml"
  when:
    - ownca_generate_locally
  become: no
  tags:
    - ownca_host_certs
    - ownca-host-certs
    - ownca_host_certificates
    - ownca-host-certificates
    - ownca_host_certs_debug
    - ownca-host-certs-debug
    - ownca_host_certificates_debug
    - ownca-host-certificates-debug
