---
# ======================================================================
#
# Tasks:
#  
#
# ======================================================================
- name: "Pre-tasks"
  block:
    - name: Include OS-specific variables.
      include_vars: "{{ lookup('first_found', params) }}"
      vars:
        params:
          files:
            - "{{ ansible_network_os | default(none) }}.yml"
            - "{{ ansible_distribution | lower }}.yml"
            - "{{ ansible_distribution.split(' ')[0] | lower }}.yml"
            - "{{ ansible_os_family | lower }}_family.yml"
            - "{{ ansible_system | lower }}.yml"
            - main.yml
          paths:
            - "vars"
      become: no
      tags:
        - openssh
        - openssh_debug
        - openssh-debug
        - install-packages

    - name: "Install packages"
      ansible.builtin.package:
        name: "{{ packages }}"
        state: present
      become: yes
      tags:
        - openssh
        - openssh_debug
        - openssh-debug
        - install-packages

# ==================================================================================================
#
# Tasks:
#  
#
# ==================================================================================================
- name: Create Required Directories for Cert authorization.
  ansible.builtin.file:
    name: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: yes
  loop:
    - "{{ sshca_cert_directory }}"
    - "{{ sshca_authorized_principals_dir }}"
  tags:
    - openssh
    - openssh_debug
    - openssh-debug

- name: Install Host CA Certificate on Hosts
  ansible.builtin.copy:
    src: "{{ sshca_key_directory }}/{{ sshca_host_pubfile }}"
    dest: "{{ sshca_hostca_certificate }}"
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: restart ssh
  tags:
    - openssh
    - openssh_debug
    - openssh-debug

- name: Install User CA Certificate on Hosts
  ansible.builtin.copy:
    src: "{{ sshca_key_directory }}/{{ sshca_user_pubfile }}"
    dest: "{{ sshca_userca_certificate }}"
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: restart ssh
  tags:
    - openssh
    - openssh_debug
    - openssh-debug

- name: "Install Configuration files"
  ansible.builtin.template:
    src: "{{ item.name }}.j2"
    dest: "{{ ssh_config_dir }}/{{ item.name }}"
    owner: root
    group: root
    mode: "{{ item.mode | default('0644') }}"
    validate: "{{ item.validate | default(none) }}"
    backup: yes
  become: yes
  loop: "{{ openssh_config_files }}"
  notify: restart ssh
  tags:
    - openssh
    - openssh_debug
    - openssh-debug
