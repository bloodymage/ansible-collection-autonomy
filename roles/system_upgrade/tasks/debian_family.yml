---
# ==================================================================================================
#
# Task: Ensure Rasbian Raspberry Pi Repo is Current
#
#
#
# ==================================================================================================
- name: "Ensure Raspbian Raspberry Pi Repo is current"
  template:
    src: "{{ role_path }}/templates/raspi.list.j2"
    dest: /etc/apt/sources.list.d/raspi.list
    owner: root
    group: root
    mode: '0644'
  become: yes
  when:
    - ansible_lsb.id is defined and ansible_lsb.id == "Raspbian"
  tags:
    - system-upgrade

- name: "Ensure sources.list is current"
  template:
    src: "sources.list.j2"
    dest: /etc/apt/sources.list
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - system-upgrade

# ==================================================================================================
#
# Task: Update all packages (Safe upgrade)
#
# Updates all packages that do not require removal of other packages to complete the upgrade
# process.  We do this first, to minimize the impact of the full upgrade done next.
#
# ==================================================================================================
- name: "{{ ansible_os_family }}: Update all packages (Safe upgrade)"
  apt:
    update_cache: yes
    upgrade: safe
    cache_valid_time: 86400 #One day
  become: yes
  tags:
    - system-upgrade

- name: "{{ ansible_os_family }}: Update all packages (Full upgrade)"
  apt:
    update_cache: yes
    upgrade: full
    cache_valid_time: 86400 #One day
  become: yes
  tags:
    - system-upgrade

# ==================================================================================================
#
# Task:
#
#
#
# ==================================================================================================
- name: "{{ ansible_os_family }}: Remove useless packages from the cache"
  apt:
    autoclean: yes
  become: yes
  tags:
    - system-upgrade

- name: "{{ ansible_os_family }}: Remove dependencies that are no longer required"
  apt:
    autoremove: yes
  become: yes
  tags:
    - system-upgrade

# - name: Reboot Hosts One at a time
#   include: "reboot_debian_hosts.yaml"
#   loop: "{{ hosts }}"
#   loop_control:
#     loop_var: host
#   tags:
#     - system-upgrade
