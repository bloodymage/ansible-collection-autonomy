---
# tasks file for mail-server
# ==================================================================================================
#
# Task: Install apps
#
# ==================================================================================================
- name: Include OS-specific variables.
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - "{{ ansible_network_os | default(none) }}.yml"
        - "{{ ansible_distribution | lower }}.yml"
        - "{{ ansible_distribution.split(' ')[0] | lower }}.yml"
        - "{{ ansible_os_family | lower }}_family.yml"
        - "{{ ansible_system | lower }}.yml"
        - main.yml
      paths:
        - "vars"
  become: no
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug
    - install-packages

- name: "Install packages"
  package:
    name: "{{ packages }}"
    state: present
  become: yes
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug
    - install-packages

- name: "Update 'dovecot_password_databases' ldap"
  ansible.builtin.set_fact:
    dovecot_password_databases: "{{ dovecot_password_databases + ['ldap'] }}"
  become: no
  when:
    - rebeldream_realm_identity_management_system == "samba"
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug
    - install-packages

- name: "Update 'dovecot_auth_mechanisms' oauth"
  ansible.builtin.set_fact:
    dovecot_auth_mechanisms: "{{ ['gssapi'] + dovecot_auth_mechanisms + ['xoauth2'] }}"
  become: no
  when:
    - rebeldream_realm_identity_management_system == "samba"
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug
    - install-packages

- name: "Get Users' password from password-store"
  ansible.builtin.set_fact:
    __mail_user: "{{ mail_user }}"
    __mail_user_password: "{{ lookup('community.general.passwordstore', password_store_id + ' create=true length=' + rebeldream_password_length + ' nosymbols=true') }}"
  vars:
    password_store_id: "{{ ansible_domain }}/domain_users/{{ mail_user }}/password"
  no_log: yes
  become: no
  delegate_to: localhost
  register: domain_user_list
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug

# ==================================================================================================
#
# Configuration tasks
#
# ==================================================================================================
- name: Install config files to /etc/dovecot
  template:
    src: "{{ item }}.j2"
    dest: "/etc/dovecot/{{ item }}"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop:
    - dovecot.conf
    - dovecot-oauth2.conf.ext
    #- passwd.db
  notify: restart dovecot
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug

- name: Install configuration files to /etc/dovecot/conf.d
  template:
    src: "{{ item }}.j2"
    dest: "/etc/dovecot/conf.d/{{ item }}"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop:
    - 10-auth.conf
    - 10-director.conf
    - 10-logging.conf
    - 10-mail.conf
    - 10-master.conf
    - 10-ssl.conf
    - 10-tcpwrapper.conf
    - 15-lda.conf
    - 15-mailboxes.conf
    - 20-imap.conf
    - 20-lmtp.conf
    - 20-managesieve.conf
    - 90-acl.conf
    - 90-plugin.conf
    - 90-quota.conf
    - 90-sieve-extprograms.conf
    - 90-sieve.conf
    - auth-checkpassword.conf.ext
    - auth-deny.conf.ext
    - auth-dict.conf.ext
    - auth-ldap.conf.ext
    - auth-master.conf.ext
    - auth-oauth2.conf.ext
    - auth-passwdfile.conf.ext
    - auth-sql.conf.ext
    - auth-static.conf.ext
    - auth-system.conf.ext
    - auth-vpopmail.conf.ext
  notify: restart dovecot
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug

- name: Ensure Virtual Directory definitions exist
  file:
    path: "/etc/dovecot/virtual/{{ item.name }}"
    state: directory
  become: yes
  loop: "{{ dovecot_virtual_mailboxes }}"
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug


- name: Install configuration files to /etc/dovecot/virtual
  template:
    src: "dovecot-virtual.j2"
    dest: "/etc/dovecot/virtual/{{ item.name }}/dovecot-virtual"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop: "{{ dovecot_virtual_mailboxes }}"
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug


- name: Ensure Sieve Pipe Bin Dir exists
  file:
    path: "{{ dovecot_sieve_pipe_bin_dir }}"
    state: directory
  become: yes
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug

    
- name: Install IMAPSieve Spam Update Filters
  template:
    src: "report-sieve.j2"
    dest: "{{ dovecot_sieve_pipe_bin_dir }}/report-{{ item.type }}.sieve"
    owner: root
    group: root
    mode: 0644
  become: yes
  loop: "{{ dovecot_imapsieve_mailboxes }}"
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug


- name: Install IMAPSieve Spam Update Filters
  template:
    src: "sa-learn.j2"
    dest: "{{ dovecot_sieve_pipe_bin_dir }}/sal-learn-{{ item.type }}.sh"
    owner: root
    group: root
    mode: 0755
  become: yes
  loop: "{{ dovecot_imapsieve_mailboxes }}"
  tags:
    - dovecot
    - dovecot_debug
    - dovecot-debug
