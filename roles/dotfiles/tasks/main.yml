---
# ==================================================================================================
#
#
#
# ==================================================================================================
- name: Ensure User Home directory exists
  ansible.builtin.file:
    dest: "{{ __dotfiles_home }}"
    state: directory
    owner: "{{ __dotfiles_owner }}"
    group: "{{ __dotfiles_group }}"
    mode: "{{ __mode }}"
  loop: "{{ dotfiles_users }}"
  become: yes
  vars:
    __dotfiles_home: "{{ item.unix_home | default(dotfiles_home + '/' + item.username) }}"
    __dotfiles_owner: "{{ item.id_number }}"
    __dotfiles_group: "{{ item.id_number }}"
    __mode: "{{ dotfiles_mode }}"
  when:
    - dotfiles_users is defined
    - item.username is defined
    - item.id_number is defined
    - (item.login_shell is not defined) or (item.login_shell != "/usr/sbin/nologin")

- name: Install User gitconfig
  ansible.builtin.template:
    src: "gitconfig.j2"
    dest: "{{ __dotfiles_home }}/.gitconfig"
    owner: "{{ __dotfiles_owner }}"
    group: "{{ __dotfiles_group }}"
    mode: "0644"
  loop: "{{ dotfiles_users }}"
  become: yes
  vars:
    __dotfiles_home: "{{ item.unix_home | default(dotfiles_home + '/' + item.username) }}"
    __dotfiles_owner: "{{ item.id_number }}"
    __dotfiles_group: "{{ item.id_number }}"
  when:
    - dotfiles_users is defined
    - item.id_number is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")

- name: Ensure user .gnupg folder exists
  ansible.builtin.file:
    path: "{{ __dotfiles_home }}/.gnupg"
    state: directory
    owner: "{{ __dotfiles_owner }}"
    group: "{{ __dotfiles_group }}"
    mode: "0700"
  loop: "{{ dotfiles_users }}"
  become: yes
  vars:
    __dotfiles_home: "{{ item.unix_home | default(dotfiles_home + '/' + item.username) }}"
    __dotfiles_owner: "{{ item.id_number }}"
    __dotfiles_group: "{{ item.id_number }}"
  when:
    - dotfiles_users is defined
    - item.id_number is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")

- name: Install gpg.conf
  ansible.builtin.template:
    src: "gpg.conf.j2"
    dest: "{{ __dotfiles_home }}/.gnupg/gpg.conf"
    owner: "{{ __dotfiles_owner }}"
    group: "{{ __dotfiles_group }}"
    mode: "0644"
  loop: "{{ dotfiles_users }}"
  become: yes
  vars:
    __dotfiles_home: "{{ item.unix_home | default(dotfiles_home + '/' + item.username) }}"
    __dotfiles_owner: "{{ item.id_number }}"
    __dotfiles_group: "{{ item.id_number }}"
  when:
    - dotfiles_users is defined
    - item.id_number is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")

- name: Install gpg-agent.conf
  ansible.builtin.template:
    src: "gpg-agent.conf.j2"
    dest: "{{ __dotfiles_home }}/.gnupg/gpg-agent.conf"
    owner: "{{ __dotfiles_owner }}"
    group: "{{ __dotfiles_group }}"
    mode: "0644"
  loop: "{{ dotfiles_users }}"
  vars:
    __dotfiles_home: "{{ item.unix_home | default(dotfiles_home + '/' + item.username) }}"
    __dotfiles_owner: "{{ item.id_number }}"
    __dotfiles_group: "{{ item.id_number }}"
  become: yes
  when:
    - dotfiles_users is defined
    - item.id_number is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")
