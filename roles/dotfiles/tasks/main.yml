---
# ==================================================================================================
#
#
#
# ==================================================================================================
- name: get user home directory
  shell: >-
    getent passwd {{ item.username }}  | awk -F: '{ print $6 }'
  changed_when: false
  register: user_home
  become: yes
  loop: "{{ users }}"
  when:
    - users is defined
  tags:
    - dotfiles
    - dotfiles_debug
    - dotfiles-debug

- name: debug output
  debug:
    var: user_home
  become: no
  tags:
    - never
    - dotfiles_debug
    - dotfiles-debug

- name: Ensure User Home directory exists
  file:
    dest: "{{ item.unix_home }}"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0700"
  loop: "{{ users }}"
  become: yes
  when:
    - users is defined
    - inventory_hostname not in groups['samba_file_servers']
    - item.unix_home is defined
    - (item.login_shell is not defined) or (item.login_shell != "/usr/sbin/nologin")
  tags:
    - dotfiles
    - dotfiles_debug
    - dotfiles-debug

# ==================================================================================================
#
#
#
# ==================================================================================================
- name: Install User gitconfig
  template:
    src: "gitconfig.j2"
    dest: "{{ item.unix_home }}/.gitconfig"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0644"
  loop: "{{ users }}"
  become: yes
  when:
    - users is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")
  tags:
    - dotfiles

# ==================================================================================================
#
#
#
# ==================================================================================================
- name: Ensure user .gnupg folder exists
  file:
    path: "{{ item.unix_home }}/.gnupg"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0700"
  loop: "{{ users }}"
  become: yes
  when:
    - users is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")
  tags:
    - dotfiles

- name: Install gpg.conf
  template:
    src: "gpg.conf.j2"
    dest: "{{ item.unix_home }}/.gnupg/gpg.conf"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0644"
  loop: "{{ users }}"
  become: yes
  when:
    - users is defined
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")
  tags:
    - dotfiles

- name: Install gpg-agent.conf
  template:
    src: "gpg-agent.conf.j2"
    dest: "{{ item.unix_home }}/.gnupg/gpg-agent.conf"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: "0644"
  loop: "{{ users }}"
  become: yes
  when:
    - (item.shell is not defined) or (item.shell != "/usr/sbin/nologin")
  tags:
    - dotfiles
