---
- name: "Add or modify host PTR records (IPv4)"
  community.general.nsupdate:
    key_algorithm: "{{ autonomy_ddns_key_algorithm }}"
    key_name: "{{ autonomy_bind_reversezone_keyname | default(autonomy_zone_name) }}"
    key_secret: "{{ __key_secret }}"
    port: 53
    protocol: tcp
    record: "{{ bind_ipv4_ptr_record }}"
    server: "{{ hostvars[item]['ansible_host'] }}"
    ttl: 3600
    type: "PTR"
    value: "{{ autonomy_fqdn | default(inventory_hostname) }}."
    zone: "{{ bind_ipv4_address.split('.')[1] }}.{{ bind_ipv4_address.split('.')[0] }}.in-addr.arpa"
    state: present
  loop: "{{ groups[__dns_servers] }}"
  become: yes
  remote_user: root
  vars:
    __nameserver: "{{ hostvars[item]['inventory_hostname_short'] }}"
    __password_store_id: "{{ autonomy_passdb }}/{{ autonomy_reversezone_domain | default(autonomy_domain) }}/hosts/{{ __nameserver }}/bind_dyndns_secret"
    __password_lookup: "{{ __password_store_id }}"
    __key_secret: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
    __dns_servers: "{{ autonomy_zone_name }}_dns_servers"
  delegate_to: "{{ hostvars[item]['ansible_host'] }}"
  when:
    - groups[__dns_servers] is defined
    - hostvars[item]['inventory_hostname'] not in groups['samba_domain_controllers'] | default([])
