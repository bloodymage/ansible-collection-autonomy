---
# ==================================================================================================
#
# Needs complete re-write
#
# New role tasks:
# 1. Determine if we are to recreate the realm (tag "recreate-realm")
# 2. If yes, primary_domain_controller = groups['samba_domain_controllers'][0]
#    if not, primary_domain_controller = {{ discovered schema master domain_controller }},
#    ie, whichever domain controller is being used to manage the database
#    "samba-tool fsmo show | grep SchemaMasterRole"
#    Ref: https://wiki.samba.org/index.php/Setting_up_RFC2307_in_AD
# 3. If yes, clear samba database files
# 4. Install Samba
# 5. If yes, create first domain controller
# 6. All other hosts join domain
#
# ==================================================================================================
# TODO: Really check if already joined
- name: "Determine if host is already joined as a domain controller."
  ansible.builtin.set_fact:
    __samba_joined_as_domain_controller: yes
  become: no
  when:
    - not __samba_recreate_realm

- name: "Ensure we have a password for the Samba Administrator account"
  ansible.builtin.set_fact:
    samba_administrator_password: "{{ lookup('community.general.passwordstore', __password_lookup) }}"
  become: no
  vars:
    __password_store_id: "{{ rebeldream_domain }}/domain_users/administrator/password"
    __password_length: "length={{ item.password_legnth | default(rebeldream_password_length) }}"
    __password_overwrite: "overwrite={{ rebeldream_overwrite_password }} backup=yes"
    __password_create: "create=true"
    __password_symbols: "nosymbols=true"
    __password_lookup: "{{ __password_store_id }} {{ __password_create }} {{ __password_length }} {{ __password_symbols }} {{ __password_overwrite }}"
  when:
    - samba_administrator_password == "password"
  no_log: yes

- name: "Include OS-specific variables."
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files: "{{ __os_variables_files }}"
      paths:
        - "vars"
  become: no

- name: "Install packages"
  ansible.builtin.package:
    name: "{{ packages }}"
    state: present
  become: yes

- name: "Initialize the domain"
  include: "create_domain.yml"
  become: no
  when:
    - __samba_recreate_realm
    - rebeldream_fqdn == __samba_schema_master

- name: "Configure smb.conf file"
  ansible.builtin.template:
    src: "smb.conf.j2"
    dest: "/etc/samba/smb.conf"
    owner: root
    group: root
    mode: 0644
  become: yes
  notify: restart samba-ad-dc

- name: "Configure user.map file"
  ansible.builtin.template:
    src: "user_map.j2"
    dest: /etc/samba/user.map
    owner: root
    group: root
    mode: 0644
  become: yes
  notify: restart samba-ad-dc

- name: "Start Samba Domain Controller"
  service:
    name: samba-ad-dc
    state: started
  become: yes

