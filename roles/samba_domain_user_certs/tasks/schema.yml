- name: "Copy user certificates to domain schema master.  Username: {{ user.username }}"
  ansible.builtin.copy:
    src: "{{ ownca_directory }}/users/certs/{{ user.username }}_{{ item }}.der"
    dest: "/tmp/{{ user.username }}_{{ item }}.cer"
    owner: root
    group: root
    mode: "0644"
  loop:
    - authentication
    - encryption
    - identification
  become: yes
  when:
    - user.id_number is defined

- name: "Copy schema extensions to domain schema master. Username: {{ user.username }}"
  ansible.builtin.template:
    src: "schema.ldif.j2"
    dest: "/tmp/{{ user.username }}_{{ item }}.ldif"
    owner: "root"
    group: "root"
    mode: "0644"
  loop:
    - authentication
    - encryption
    - identification
  become: yes
  when:
    - user.id_number is defined

# ==================================================================================================
#
# Currently, this gives an error if already installed, what is really needed is a way to test if
# installed, and if so, don't install again.
#
# ==================================================================================================
- name: "Install user certificates into ldap attributes. Username: {{ user.username }}"
  ansible.builtin.command:
    cmd: >
      ldbmodify
      -H /var/lib/samba/private/sam.ldb
      "/tmp/{{ user.username }}_{{ item }}.ldif"
      --option='dsdb:schema update allowed'=true
  loop:
    - authentication
    - encryption
    - identification
  become: yes
  ignore_errors: yes
  when:
    - user.id_number is defined
