---
# handlers file for collection_handlers
# ==================================================================================================
#
# Misc Handlers
#
# ==================================================================================================
- name: Update System CA Certificates
  ansible.builtin.command:
    cmd: "update-ca-certificates"
  become: yes
  listen:
    - "update system ca certificates"
    - "update ca-certificates"

- name: "postfix tls"
  ansible.builtin.copy:
    src: /etc/ssl/certs/ca-certificates.crt
    dest: /var/spool/postfix/etc/ssl/certs/ca-certificates.crt
    owner: root
    group: root
    mode: "0644"
    remote_src: yes
  become: yes
  notify: reload postfix
  listen:
    - "update ca-certificates"
  when:
    - inventory_hostname in groups['postfix_servers'] | default([])

# ==================================================================================================
#
# Restart Service Handlers
#
# ==================================================================================================
- name: restart apache
  ansible.builtin.service:
    name: apache2
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "Restart apache"
    - "restart keytab"
  when:
    - inventory_hostname in groups['apache_servers'] | default([])

- name: Restart Bind9
  ansible.builtin.service:
    name: bind9
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart bind"
    - "restart bind9"
    - "restart tls"
  when:
    - inventory_hostname in groups['dns_servers'] | default([])

- name: Restart Dovecot
  ansible.builtin.service:
    name: dovecot
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart keytab"
  when:
    - inventory_hostname in groups['dovecot_servers'] | default([])

- name: Restart Keycloak
  ansible.builtin.service:
    name: keycloak
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart keycloak"
    - "restart keytab"
  when:
    - inventory_hostname in groups['keycloak_servers'] | default([])

- name: Restart Mosquitto
  ansible.builtin.service:
    name: mosquitto
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
  when:
    - inventory_hostname in groups['mosquitto_servers'] | default([])

- name: Restart MySQL
  ansible.builtin.service:
    name: mysql
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
  when:
    - inventory_hostname in groups ['mysql_compatable_servers'] | default([])

- name: Restart nginx
  ansible.builtin.service:
    name: nginx
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
  when:
    - inventory_hostname in groups ['nginx_servers'] | default([])

- name: Restart Postfix
  ansible.builtin.service:
    name: postfix
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart keytab"
  when:
    - inventory_hostname in groups['postfix_servers'] | default([])

- name: Restart Samba Domain Controller
  ansible.builtin.service:
    name: samba-ad-dc
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart samba-ad-dc"
  when:
    - inventory_hostname in groups['samba_domain_controllers'] | default([])

- name: Restart SMBD Server
  ansible.builtin.service:
    name: smbd
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart samba file server"
  when:
    - inventory_hostname in groups['samba_file_servers']

- name: Restart NMBD Server
  ansible.builtin.service:
    name: nmbd
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart samba file server"
  when:
    - inventory_hostname in groups['samba_file_servers']

- name: Restart SSH Server
  ansible.builtin.service:
    name: ssh
    state: restarted
  become: yes
  listen:
    - "restart all"

- name: Restart Winbind Server
  ansible.builtin.service:
    name: winbind
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
    - "restart samba file server"
  when:
    - inventory_hostname in groups['samba_file_servers']

- name: restart sssd
  ansible.builtin.service:
    name: sssd
    state: restarted
  become: yes
  listen:
    - "restart all"
    - "restart tls"
  when:
    - inventory_hostname in groups['sssd']

- name: restart unattended-upgrades
  ansible.builtin.service:
    name: unattended-upgrades
    state: restarted
  become: yes
  listen:
    - "restart all"

# ==================================================================================================
#
# Reload Handlers
#
# ==================================================================================================
- name: reload apache
  ansible.builtin.service:
    name: apache2
    state: reloaded
  become: yes
  listen:
    - "reload all"
    - "reload tls"
  when:
    - inventory_hostname in groups['apache_servers']

- name: reload nginx
  ansible.builtin.service:
    name: nginx
    state: reloaded
  become: yes
  listen:
    - "reload all"
    - "reload tls"
  when:
    - inventory_hostname in groups['nginx_servers']

- name: "Reload Postfix"
  ansible.builtin.service:
    name: postfix
    state: reloaded
  become: yes
  listen:
    - "reload all"
    - "reload tls"
    - "reload postfix"
  when:
    - inventory_hostname in groups['postfix_servers']

- name: "Reload Samba Domain Controller"
  ansible.builtin.service:
    name: samba-ad-dc
    state: restarted
  become: yes
  listen:
    - "reload all"
    - "reload tls"
    - "reload samba-ad-dc"
  when:
    - inventory_hostname in groups['samba_domain_controllers'] | default([])

# ==================================================================================================
#
# Start Handlers
#
# ==================================================================================================
- name: start sssd
  ansible.builtin.service:
    name: sssd
    state: started
  become: yes
  when:
    - inventory_hostname in groups['sssd']

# ==================================================================================================
#
# Enable Handlers
#
# ==================================================================================================
- name: enable keycloak
  ansible.builtin.service:
    name: "keycloak"
    state: "{{ item }}"
  loop:
    - enabled
    - started
  become: yes
