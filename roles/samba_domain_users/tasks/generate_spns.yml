- name: Add SPN for Samba Users
  shell: >
    samba-tool spn add "{{ item.spn }}/{{ item.host }}" "{{ user.username }}"
  become: yes
  loop: "{{ user.spns }}"
  when:
    - __samba_schema_master is defined
    - inventory_hostname == __samba_schema_master
    - item.spn is defined
    - item.host is defined
  delegate_to: "{{ __samba_schema_master }}"
  ignore_errors: yes
  run_once: yes

- name: Create Keytab for Samba Users
  shell: >
    samba-tool domain exportkeytab --principal "{{ item.spn }}/{{ item.host }}" "/tmp/{{ user.ansible_facts.username }}-{{ item.spn }}-{{ item.host }}.keytab"
  become: yes
  loop: "{{ user.ansible_facts.spns }}"
  when:
    - __samba_schema_master is defined
    - inventory_hostname == __samba_schema_master
    - item.spn is defined
    - item.host is defined
  delegate_to: "{{ __samba_schema_master }}"
  run_once: yes

- name: "Fetch keytab"
  ansible.builtin.fetch:
    src: "/tmp/{{ user.ansible_facts.username }}-{{ item.spn }}-{{ item.host }}.keytab"
    dest: "/tmp/{{ user.ansible_facts.username }}-{{ item.spn }}-{{ item.host }}.keytab"
    flat: yes
  become: yes
  loop: "{{ user.ansible_facts.spns }}"
  when:
    - __samba_schema_master is defined
    - item.spn is defined
    - inventory_hostname == __samba_schema_master
