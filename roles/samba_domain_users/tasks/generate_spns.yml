- name: Add SPN for Samba Users
  shell: >
    samba-tool spn add "{{ item.spn }}/{{ item.host }}" "{{ user.username }}"
  become: yes
  loop: "{{ user.spns }}"
  when:
    - __samba_schema_master is defined
    - inventory_hostname == __samba_schema_master
    - item.spn is defined
    - item.host is defined
  delegate_to: "{{ __samba_schema_master }}"
  ignore_errors: yes
  run_once: yes
  tags:
    - samba_domain_users
    - samba-domain-users
    - samba_domain_users_debug
    - samba-domain-users-debug
    - recreate-realm
    - recreate-realm-debug

- name: Create Keytab for Samba Users
  shell: >
    samba-tool domain exportkeytab --principal "{{ item.spn }}/{{ item.host }}" "/tmp/{{ user.username }}-{{ item.spn }}-{{ item.host }}.keytab"
  become: yes
  loop: "{{ user.spns }}"
  when:
    - __samba_schema_master is defined
    - inventory_hostname == __samba_schema_master
    - item.spn is defined
    - item.host is defined
  delegate_to: "{{ __samba_schema_master }}"
  run_once: yes
  tags:
    - samba_domain_users
    - samba-domain-users
    - samba_domain_users_debug
    - samba-domain-users-debug
    - recreate-realm
    - recreate-realm-debug

- name: "Fetch keytab"
  fetch:
    src: "/tmp/{{ user.username }}-{{ item.spn }}-{{ item.host }}.keytab"
    dest: "/tmp/{{ user.username }}-{{ item.spn }}-{{ item.host }}.keytab"
    flat: yes
  become: yes
  loop: "{{ user.spns }}"
  when:
    - __samba_schema_master is defined
    - item.spn is defined
    - inventory_hostname == __samba_schema_master
  tags:
    - samba_domain_users
    - samba-domain-users
    - samba_domain_users_debug
    - samba-domain-users-debug
    - recreate-realm
    - recreate-realm-debug
